<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Transporte</title>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="./assets/css/styles.css">
    <link rel="stylesheet" href="./assets/css/components.css">
    <link rel="stylesheet" href="./assets/css/responsive.css">
    <link rel="stylesheet" href="./assets/css/navigation.css">
    <link rel="stylesheet" href="./assets/css/email-config.css">
    <link rel="stylesheet" href="./assets/css/reports.css">
    <link rel="stylesheet" href="./assets/css/s3-config.css">
    <link rel="stylesheet" href="./assets/css/freights.css">
    <link rel="stylesheet" href="./assets/css/loader.css">
    
</head>
<body>
    <!-- Loader Animado -->
    <div class="app-loader" id="appLoader">
        <div class="loader-content">
            <div class="truck-container">
                <div class="road"></div>
                <div class="truck">
                    <div class="smoke">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                    <div class="truck-cabin"></div>
                    <div class="truck-body"></div>
                    <div class="truck-wheels">
                        <div class="wheel"></div>
                        <div class="wheel"></div>
                        <div class="wheel"></div>
                    </div>
                </div>
            </div>
            <div class="loader-text">
                Cargando aplicaci√≥n
                <span class="loading-dots">
                    <span>.</span>
                    <span>.</span>
                    <span>.</span>
                </span>
            </div>
            <div class="loader-subtext">Preparando tu espacio de trabajo</div>
            <div class="loader-progress">
                <div class="loader-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Header principal -->
    <header class="header">
        <div class="container">
            <!-- Bot√≥n de men√∫ m√≥vil (se crea din√°micamente) -->
            
            <div class="header-content">
                <h1>üöö Gesti√≥n de Transporte</h1>
                
                <!-- Informaci√≥n del usuario -->
                <div class="user-section">
                    <div id="userInfo" class="user-info">
                        <!-- Se llena din√°micamente -->
                    </div>
                    <button id="logoutBtn" class="logout-btn" onclick="navigationManager.logout()" title="Cerrar Sesi√≥n">
                        <span class="logout-icon">üö™</span>
                        <span class="logout-text">Cerrar Sesi√≥n</span>
                    </button>
                </div>
            </div>

            <!-- Navegaci√≥n principal -->
            <nav class="nav-tabs">
                <!-- Se llena din√°micamente seg√∫n el rol del usuario -->
            </nav>

            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <!-- Se llena din√°micamente -->
            </div>
        </div>
    </header>

    <!-- Contenido principal -->
    <main class="container">
        
        <!-- Secci√≥n Dashboard -->
        <section id="dashboard" class="content-section active">
            <!-- Loader temporal -->
            <div class="loading-fallback">
                <div class="loading-spinner">‚è≥ Cargando dashboard...</div>
                <div class="fallback-content" style="margin-top: 20px;">
                    <div class="card">
                        <h3>üìä Dashboard</h3>
                        <p>Sistema de gesti√≥n de transporte inicializando...</p>
                        <div class="stats-container">
                            <div class="stat-card">
                                <h4>Veh√≠culos</h4>
                                <p class="stat-value">--</p>
                            </div>
                            <div class="stat-card">
                                <h4>Conductores</h4>
                                <p class="stat-value">--</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- El contenido se genera din√°micamente por DashboardView -->
        </section>

        <!-- Secci√≥n Veh√≠culos -->
        <section id="vehicles" class="content-section">
            <!-- El contenido se genera din√°micamente por VehicleView -->
        </section>

        <!-- Secci√≥n Conductores -->
        <section id="drivers" class="content-section">
            <!-- El contenido se genera din√°micamente por DriverView -->
        </section>

        <!-- Secci√≥n Documentos -->
        <section id="documents" class="content-section">
            <!-- El contenido se genera din√°micamente por DocumentView -->
        </section>

        <!-- Secci√≥n Gastos -->
        <section id="expenses" class="content-section">
            <!-- El contenido se genera din√°micamente por ExpenseView -->
        </section>

        <!-- Secci√≥n Fletes -->
        <section id="freights" class="content-section">
            <!-- El contenido se genera din√°micamente por FreightView -->
        </section>

        <!-- Secci√≥n Reportes -->
        <section id="reports" class="content-section">
            <!-- El contenido se genera din√°micamente por ReportView -->
        </section>

        <!-- Secci√≥n Configuraci√≥n de Email -->
        <section id="email-config" class="content-section">
            <!-- El contenido se genera din√°micamente por EmailConfigView -->
        </section>

    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2024 Sistema de Gesti√≥n de Transporte. Todos los derechos reservados.</p>
            <p>Desarrollador Sisto Ferney Guarin</p>
        </div>
    </footer>

    <!-- Librer√≠as externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1600.0.min.js"></script>

    <!-- Scripts del Core -->
    <script src="./assets/js/services/StorageService.js"></script>
    <script src="./assets/js/services/S3Service.js"></script>
    <script src="./assets/js/services/AuthService.js"></script>
    <script src="./assets/js/services/EmailService.js"></script>
    <script src="./assets/js/services/GoogleMapsService.js"></script>
    <script src="./assets/js/services/OpenStreetMapService.js"></script>
    <script src="./assets/js/services/MapService.js"></script>
    
    <!-- Scripts de Modelos -->
    <script src="./assets/js/models/Vehicle.js"></script>
    <script src="./assets/js/models/Driver.js"></script>
    <script src="./assets/js/models/Document.js"></script>
    <script src="./assets/js/models/Expense.js"></script>
    <script src="./assets/js/models/Freight.js"></script>
    <script src="./assets/js/models/User.js"></script>
    
    <!-- Scripts de Controladores -->
    <script src="./assets/js/controllers/BaseController.js"></script>
    <script src="./assets/js/controllers/AuthController.js"></script>
    <script src="./assets/js/controllers/VehicleController.js"></script>
    <script src="./assets/js/controllers/DriverController.js"></script>
    <script src="./assets/js/controllers/DocumentController.js"></script>
    <script src="./assets/js/controllers/DashboardController.js"></script>
    <script src="./assets/js/controllers/ExpenseController.js"></script>
    <script src="./assets/js/controllers/FreightController.js"></script>
    
    <!-- Scripts de Vistas -->
    <script src="./assets/js/views/BaseView.js"></script>
    <script src="./assets/js/views/AdminSetupView.js"></script>
    <script src="./assets/js/views/S3ConfigView.js"></script>
    <script src="./assets/js/views/DashboardView.js"></script>
    <script src="./assets/js/views/VehicleView.js"></script>
    <script src="./assets/js/views/DriverView.js"></script>
    <script src="./assets/js/views/DocumentView.js"></script>
    <script src="./assets/js/views/ExpenseView.js"></script>
    <script src="./assets/js/views/FreightView.js"></script>
    <script src="./assets/js/views/EmailConfigView.js"></script>
    <script src="./assets/js/views/ReportView.js"></script>
    
    <!-- Scripts del Sistema de Navegaci√≥n -->
    <script src="./assets/js/core/Router.js"></script>
    <script src="./assets/js/core/NavigationManager.js"></script>
    
    <!-- Script de Aplicaci√≥n Principal -->
    <script src="./assets/js/app/Application.js"></script>

    <!-- Script de inicializaci√≥n -->
    <script>
        // Configurar variables globales para compatibilidad
        window.showSection = function(sectionName) {
            if (window.router) {
                window.router.navigateTo(sectionName);
            }
        };

        // Funci√≥n para logout
        window.logout = async function() {
            if (window.navigationManager) {
                await window.navigationManager.logout();
            } else {
                // Fallback si navigationManager no est√° disponible
                if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
                    await AuthController.performLogout();
                }
            }
        };

        // Funci√≥n para ocultar loaders cuando el contenido se carga
        window.hideLoader = function() {
            const loaders = document.querySelectorAll('.loading-fallback');
            loaders.forEach(loader => {
                loader.style.display = 'none';
            });
        };

        // Funci√≥n de diagn√≥stico para verificar estado de carga de scripts
        window.diagnoseScriptLoading = function() {
            console.log('üîç Diagn√≥stico de carga de scripts:');

            const coreServices = ['StorageService', 'S3Service', 'AuthService', 'EmailService'];
            const views = ['S3ConfigView', 'DashboardView', 'VehicleView', 'DriverView'];
            const controllers = ['DashboardController', 'VehicleController', 'DriverController'];

            const checkClasses = (classes, category) => {
                console.log(`\nüìÇ ${category}:`);
                classes.forEach(className => {
                    const isAvailable = typeof window[className] !== 'undefined';
                    const status = isAvailable ? '‚úÖ' : '‚ùå';
                    console.log(`  ${status} ${className}: ${isAvailable ? 'Cargado' : 'No disponible'}`);
                });
            };

            checkClasses(coreServices, 'Servicios Core');
            checkClasses(views, 'Vistas');
            checkClasses(controllers, 'Controladores');

            // Verificar AWS SDK
            console.log(`\nüåê Librer√≠as externas:`);
            console.log(`  ${typeof window.AWS !== 'undefined' ? '‚úÖ' : '‚ùå'} AWS SDK: ${typeof window.AWS !== 'undefined' ? 'Cargado' : 'No disponible'}`);
            console.log(`  ${typeof window.XLSX !== 'undefined' ? '‚úÖ' : '‚ùå'} XLSX: ${typeof window.XLSX !== 'undefined' ? 'Cargado' : 'No disponible'}`);

            return {
                coreServices: coreServices.map(name => ({ name, loaded: typeof window[name] !== 'undefined' })),
                views: views.map(name => ({ name, loaded: typeof window[name] !== 'undefined' })),
                controllers: controllers.map(name => ({ name, loaded: typeof window[name] !== 'undefined' }))
            };
        };

        // Inicializar aplicaci√≥n principal
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üéâ Sistema de Gesti√≥n de Transporte cargando...');
            
            // Prevenir inicializaci√≥n m√∫ltiple
            if (window.appInitialized) {
                console.log('‚ö†Ô∏è Aplicaci√≥n ya inicializada, ignorando...');
                return;
            }
            window.appInitialized = true;
            
            // Inicializar aplicaci√≥n principal
            if (typeof Application !== 'undefined') {
                window.app = new Application();
                window.app.initialize().then(() => {
                    console.log('‚úÖ Aplicaci√≥n inicializada correctamente');
                    // Ocultar loader despu√©s de 2 segundos
                    setTimeout(() => {
                        window.hideLoader();
                    }, 2000);
                }).catch(error => {
                    console.error('‚ùå Error inicializando aplicaci√≥n:', error);
                });
            } else {
                console.error('‚ùå Application class not found');
                console.log('Available classes:', Object.keys(window).filter(key => key.includes('Application') || key.includes('App')));
            }
            
            
            // Agregar spinner CSS si no existe
            if (!document.querySelector('#spinner-styles')) {
                const spinnerStyles = document.createElement('style');
                spinnerStyles.id = 'spinner-styles';
                spinnerStyles.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(spinnerStyles);
            }
        });

        // Manejar errores de carga de scripts
        window.addEventListener('error', function(e) {
            if (e.target.tagName === 'SCRIPT') {
                console.error('Error al cargar script:', e.target.src);
                // Mostrar mensaje de error al usuario
                const errorMsg = document.createElement('div');
                errorMsg.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0;
                    background: #e74c3c; color: white; padding: 10px;
                    text-align: center; z-index: 10000;
                `;
                errorMsg.textContent = 'Error al cargar algunos componentes. Recarga la p√°gina.';
                document.body.insertBefore(errorMsg, document.body.firstChild);
            }
        });
    </script>
</body>
</html>